{% extends 'games/base.html' %}
{% load static %}

{% block title %}Réponses de {{ viewed_user.first_name }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/view_user_responses.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
{% endblock %}

{% block content %}
<div class="results-container">
    <div class="results-header">
        <h1>Réponses de {{ viewed_user.first_name }}</h1>
        <a href="{% url 'all_responses' %}" class="admin-btn secondary">
            <i class="fas fa-arrow-left"></i>
            Retour à la liste
        </a>
    </div>

    <div class="results-grid">
        <!-- Score Total -->
        <div class="score-card total-score">
            <div class="score-header">
                <i class="fas fa-trophy"></i>
                <h2>Score Total</h2>
            </div>
            <div class="score-content">
                <div class="main-score">{{ total_score }}</div>
            </div>
        </div>

        <!-- Sondage Transport -->
        <div class="score-card transport-score">
            <div class="score-header">
                <i class="fas fa-bus"></i>
                <h2>Sondage Transport</h2>
            </div>
            <div class="score-content">
                {% if transport_guess %}
                    <div class="transport-grid">
                        {% if 'bus' in transport_guess.transports %}
                            <div class="transport-item" title="Bus">
                                <i class="fas fa-bus"></i>
                            </div>
                        {% endif %}
                        {% if 'train' in transport_guess.transports %}
                            <div class="transport-item" title="Train">
                                <i class="fas fa-train"></i>
                            </div>
                        {% endif %}
                        {% if 'plane' in transport_guess.transports %}
                            <div class="transport-item" title="Avion">
                                <i class="fas fa-plane"></i>
                            </div>
                        {% endif %}
                        {% if 'car' in transport_guess.transports %}
                            <div class="transport-item" title="Voiture">
                                <i class="fas fa-car"></i>
                            </div>
                        {% endif %}
                        {% if 'ship' in transport_guess.transports %}
                            <div class="transport-item" title="Bateau">
                                <i class="fas fa-ship"></i>
                            </div>
                        {% endif %}
                        {% if 'walking' in transport_guess.transports %}
                            <div class="transport-item" title="Marche">
                                <i class="fas fa-walking"></i>
                            </div>
                        {% endif %}
                        {% if 'bike' in transport_guess.transports %}
                            <div class="transport-item" title="Vélo">
                                <i class="fas fa-bicycle"></i>
                            </div>
                        {% endif %}
                        {% if 'subway' in transport_guess.transports %}
                            <div class="transport-item" title="Métro/RER">
                                <i class="fas fa-subway"></i>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>Pas de réponse pour le sondage transport</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- GeoGuessr -->
        <div class="score-card map-score">
            <div class="score-header">
                <i class="fas fa-map-marker-alt"></i>
                <h2>GeoGuessr</h2>
            </div>
            <div class="score-content">
                {% if map_guess %}
                    <div class="map-result">
                        <div class="city-name">{{ map_guess.city_name }}</div>
                        <div class="map-container">
                            <div id="map" class="result-map"></div>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>Pas de réponse pour GeoGuessr</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if map_guess %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const guessLat = {{ map_guess.latitude }};
        const guessLng = {{ map_guess.longitude }};
        const cityName = "{{ map_guess.city_name }}";

        const map = L.map('map', {
            center: [46.603354, 1.888334],
            zoom: 4,
            zoomControl: true,
            minZoom: 4,
            maxZoom: 12
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const marker = L.marker([guessLat, guessLng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<i class="fas fa-map-marker-alt"></i>',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            })
        }).addTo(map);

        const crosshairsButton = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'leaflet-control-crosshairs', container);
                button.innerHTML = '<i class="fas fa-crosshairs"></i>';
                button.href = '#';
                button.title = 'Centrer sur le marqueur';
                
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    map.setView([guessLat, guessLng], 12);
                });
                
                return container;
            }
        });

        const homeButton = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'leaflet-control-home', container);
                button.innerHTML = '<i class="fas fa-home"></i>';
                button.href = '#';
                button.title = 'Vue initiale';
                
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    map.setView([46.603354, 1.888334], 4);
                });
                
                return container;
            }
        });
        
        map.addControl(new crosshairsButton());
        map.addControl(new homeButton());
    });
</script>
{% endif %}
{% endblock %} 